

################# Header: Define the base system you want to use ################
# Reference of the kind of base you want to use (e.g., docker, debootstrap, shub).
Bootstrap: docker
# Select the docker image you want to use (Here we choose tensorflow)
From: ubuntu:noble


################# Section: Defining the system #################################
# Commands in the %post section are executed within the container.
%post
        echo "Installing Tools with apt-get"
     	apt-get update

        apt-get install -y cmake libcupti-dev libyaml-dev wget unzip zlib1g-dev libjpeg8 libwebp-dev liblcms2-2
        apt-get clean
        echo "Installing things with pip"

       	
      	apt-get update --fix-missing && apt-get install -y automake build-essential bzip2 wget git default-jre unzip

	# Install miniconda 
	wget https://repo.continuum.io/miniconda/Miniconda3-latest-Linux-x86_64.sh
	bash Miniconda3-latest-Linux-x86_64.sh -b -f -p /miniconda3/
	rm Miniconda3-latest-Linux-x86_64.sh

	# pull the conda functions in . /miniconda3/etc/profile.d/conda.sh and make pip, etc. available while in %post
	export PATH="/miniconda3/bin:$PATH"
	
	# Use conda to install pip, numpy
	conda install -y -c conda-forge pip numpy 
        conda install -c "nvidia/label/cuda-12.6.3" cuda-toolkit

	# Help conda resolving Python "import" 
	conda update --all
        
        echo "Creating mount points"
        mkdir /dataset
        mkdir /tmp_log
        mkdir /final_log


# Environment variables that should be sourced at runtime.
%environment
        # use bash as default shell
        SHELL=/bin/bash
        export SHELL
        export PATH=/miniconda3/bin:$PATH
        
      
